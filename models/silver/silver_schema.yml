version: 2

models:

- name: stg__stocks
  description: | 
    "cleans raw stock data to remove null values (closed trading days)
     and assert positive stock price values"
  
  data_tests:
    - dbt_utils.expression_is_true:
        arguments:
          expression: "close >= low and close <= high"
    - dbt_utils.expression_is_true:
        arguments:
          expression: "open >= low and open <= high"
    - dbt_utils.unique_combination_of_columns:
        arguments:
          combination_of_columns: ['trade_date', 'ticker']

  columns:
    - name: trade_date
      description: "market date"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true: 
            arguments:
              expression: "<= current_date"

    - name: ticker
      description: "symbol"
      data_tests:
        - not_null

    - name: open
      description: "sessions opening price"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: high
      description: "session high price"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: low
      description: "sessions low price"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: close
      description: "session closing price"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: volume
      description: "total shares traded during session"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: loaded_at
      description: "ingest ts"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: "<= current_timestamp"


- name: int__price_changes
  description: "..."

  data_tests:
    - dbt_utils.unique_combination_of_columns:
        arguments:
          combination_of_columns: ['ticker', 'rn']
    - dbt_utils.expression_is_true:
        arguments:
          expression: "abs(abs(delta) - (gain + loss)) <= 1e-9"
    - dbt_utils.expression_is_true:
        arguments:
          expression: "(delta > 0 and gain = delta) or (delta <= 0 and gain = 0)"
    - dbt_utils.expression_is_true:
        arguments:
          expression: "(delta < 0 and loss = -delta) or (delta >= 0 and loss = 0)"

  columns:
    - name: trade_date
      description: "market date"
      data_tests:
        - not_null

    - name: ticker
      description: "symbol"
      data_tests:
        - not_null

    - name: close 
      description: "session close price"
      data_tests:
        - not_null
      
    - name: delta
      description: "close - lag(close); null on the first row per ticker"

    - name: gain
      description: “positive part of delta; max(delta, 0)”
      data_tests: 
        - not_null
        - dbt_utils.expression_is_true: 
            arguments: 
              expression: ">= 0"

    - name: loss
      description: “magnitude of negative delta; max(-delta, 0) (stored as non-negative)”
      data_tests: 
        - not_null
        - dbt_utils.expression_is_true: 
            arguments: 
              expression: ">= 0"

    - name: rn
      description: "sequential number for each trading day within a ticker's history, used for ordering."
      data_tests: 
        - not_null

    - name: period_check
      description: |
            "count(*) over(partition by ticker 
            order by trade_date asc, loaded_at asc 
            rows between 13 preceding and current row)"
      data_tests:
        - dbt_utils.expression_is_true:
            arguments:
              expression: "between 1 and 14"

    - name: loaded_at
      description: "ingest ts"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: "<= current_timestamp"

- name: int__rsi_sma
  description: "rolling 14-row SMA of gain/loss per ticker; inputs from int__price_changes"
  
  data_tests:
    - dbt_utils.unique_combination_of_columns:
        arguments:
          combination_of_columns: ['ticker', 'rn']
 
  columns: 
    - name: trade_date
      description: "market date"
      data_tests: 
        - not_null
   
    - name: ticker
      description: "symbol"
      data_tests: 
        - not_null
   
    - name: close
      description: "session close price"
      data_tests:
        - not_null
   
    - name: gain
      description: “positive part of delta; max(delta, 0)”
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: loss
      description: “magnitude of negative delta; max(-delta, 0) (stored as non-negative)”
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: sma_gain
      description: "avg(gain) over 14-row frame"
      data_tests:
        - not_null:
            config:
              where: "rn >= 14"
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"
              where: "rn >= 14" 

    - name: sma_loss
      description: "avg(loss) over 14-row frame"
      data_tests:
        - not_null:
            config:
              where: "rn >= 14"
        - dbt_utils.expression_is_true:
            arguments: 
              expression: ">= 0"
              where: "rn >= 14"

    - name: rn
      description: "sequential number for each trading day within a ticker's history, used for ordering."
      data_tests:
        - not_null

    - name: loaded_at
      description: "ingest ts"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true: 
            arguments:
              expression: "<= current_timestamp"

    - name: period_check
      description: |
        "count(*) over(partition by ticker 
        order by trade_date asc, loaded_at asc 
        rows between 13 preceding and current row)"
      data_tests:
        - dbt_utils.expression_is_true:
            arguments:
              expression: "between 1 and 14"

- name: int__rsi_wilder
  description: "Wilder-smoothed (α = 1/14) averages of gain/loss per ticker; seeded from int__rsi_sma at rn=14."
  
  data_tests:
    - dbt_utils.unique_combination_of_columns:
        arguments:
          combination_of_columns: ['ticker', 'rn']

  columns:     
    - name: ticker
      description: "symbol"
      data_tests: 
        - not_null

    - name: rn
      description: "sequential number for each trading day within a ticker's history, used for ordering."
      data_tests:
        - not_null

    - name: trade_date
      description: "market date"
      data_tests: 
        - not_null
   
    - name: gain
      description: “positive part of delta; max(delta, 0)”
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: loss
      description: “magnitude of negative delta; max(-delta, 0) (stored as non-negative)”
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"

    - name: wilder_gain
      description: "Wilder EMA of gain with α=1/14 (seed = sma_gain at rn=14)"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"


    - name: wilder_loss
      description: "Wilder EMA of loss with α=1/14 (seed = sma_loss at rn=14)"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments: 
              expression: ">= 0"

- name: stg__vix_with_versions
  description: |
      staging model that joins VIX source data with threshold versions,
      enabling efficient updating of regime ranges and versioning.

  data_tests:
    - dbt_utils.unique_combination_of_columns:
        arguments:
          combination_of_columns: ['trade_date', 'version_id']

  columns:
    - name: trade_date
      description: "market date; primary key" 
      data_tests:
        - not_null
        - dbt_utils.expression_is_true: 
            arguments:
              expression: "<= current_date"


    - name: close 
      description: "VIX session close price"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true: 
            arguments:
              expression: "> 0"

    - name: loaded_at
      description: "ingest ts"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true: 
            arguments:
              expression: "<= current_timestamp"

    - name: version_id
      description: "threshold version id from seed file"
      data_tests: 
        - not_null

    - name: version_name
      description: "threshold version descriptive name"
      data_tests: 
        - not_null

    - name: complacent_max
      description: "upper bound for complacent regime"
      data_tests: 
        - not_null
        - dbt_utils.expression_is_true: 
            arguments:
              expression: "< normal_max AND  normal_max < elevated_max"

    - name: normal_max
      description: "upper bound for normal regime"
      data_tests: 
        - not_null

    - name: elevated_max
      description: "upper bound for elevated regime"
      data_tests: 
        - not_null

    - name: effective_date
      description: "date which VIX regime classification ranges were last modified"
      data_tests: 
        - not_null

    - name: version_rank
      description: "int value in which '1' for the represents the version with the most recent 'effective_date'"
      data_tests: 
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 1"

- name: int__regime_classification
  description: |
   "assigns regime classifications to the VIX closing values 
   using the most recent applicable threshold version"

  columns:
    - name: trade_date
      description: "market date; primary key" 
      data_tests:
        - unique
        - not_null
        - dbt_utils.expression_is_true: 
            arguments:
              expression: "<= current_date"
        - relationships:
            arguments:
              to: ref('stg__vix_with_versions')
              field: trade_date

              
    - name: close 
      description: "VIX session close price"
      data_tests:
        - dbt_utils.expression_is_true: 
            arguments:
              expression: "> 0"
    - name: regime
      description: |
        market volatility classification based on VIX close:
        - complacent: very low volatility (VIX < 12)
        - normal: typical conditions (VIX 12-20)
        - elevated: increased uncertainty (VIX 20-30)
        - crisis: extreme volatility (VIX 30+)
      data_tests: 
        - not_null
        - accepted_values: 
            arguments: 
              values: ['complacent', 'normal', 'elevated', 'crisis']

    - name: loaded_at
      description: "ingest ts"
      data_tests:
        - not_null
        - dbt_utils.expression_is_true:
            arguments:  
              expression: "<= current_timestamp"
- name: int__regime_changes
  description: |
   "dimension table tracking regime period - consecutive trading days 
   where VIX maintained the same volatility classification."
  
  columns: 
    - name: regime
      description: "market volatility classification"
      data_tests: 
        - not_null
        - accepted_values: 
            arguments: 
              values: ['complacent', 'normal', 'elevated', 'crisis']
    - name: regime_period_id
      description: |
        "unique int value assigned to each range of VIX trade_dates under the same regime
         classification. sequential numbering based on chronological order."
      data_tests: 
        - unique
        - not_null
    - name: days_in_regime
      description: |
       "int value count of the trading days in this regime period."
      data_tests: 
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: ">= 0"
    - name: start_date
      description: "first trading day of this regime period"
      data_tests: 
        - not_null
        - dbt_utils.expression_is_true:
            arguments:
              expression: "<= end_date"
    - name: end_date
      description: "last trading day of this regime period"
      data_tests: 
        - not_null
